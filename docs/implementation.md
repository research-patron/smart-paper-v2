# Smart Paper v2 実装概要

このドキュメントでは、Smart Paper v2の主要コンポーネントとその実装について説明します。

## アーキテクチャ概要

Smart Paper v2は以下のコンポーネントで構成されています：

1. **フロントエンド**: React + TypeScript（Material-UIを使用）
2. **バックエンド**: Cloud Functions (Python)
3. **データベース**: Firebase Firestore
4. **ストレージ**: Firebase Cloud Storage
5. **非同期処理**: Cloud Tasks
6. **AI翻訳エンジン**: Vertex AI (Gemini API)

## バックエンド実装の詳細

### Cloud Functions (Python)

Cloud Functions for Pythonを使用して、以下の3つの主要なエンドポイントを実装しています：

1. **process_pdf**: PDFアップロードを受け付け、Cloud Storageへの保存、メタデータ抽出のタスク追加を行います。
2. **process_pdf_task**: Cloud Tasksからトリガーされ、PDF処理（メタデータ抽出、翻訳、要約）を実行します。
3. **get_signed_url**: 保存されたPDFや翻訳結果へのアクセスのための署名付きURLを生成します。

### Vertex AI (Gemini API) 連携

Vertex AIのコンテキストキャッシュ機能を使用して、効率的に論文を処理します：

1. **コンテキストキャッシュの作成**: PDFをVertex AIのコンテキストキャッシュに登録します。
2. **プロンプト処理**: メタデータ抽出、翻訳、要約などの各タスクに最適化されたプロンプトを使用します。
3. **エラーハンドリング**: APIタイムアウトやサービス一時停止などのエラーに対してリトライロジックを実装しています。

### 非同期処理とタスク管理

Cloud Tasksを使用して、バックグラウンドで長時間実行されるタスクを管理します：

1. **タスクキュー**: translate-pdf-queue を作成し、各種処理タスクを管理します。
2. **タスクの連鎖**: メタデータ抽出 → 章ごとの翻訳 → 章ごとの要約 → 関連論文推薦 の流れでタスクを連鎖させています。
3. **ステータス管理**: Firestoreのステータスフィールドを更新して、処理の進捗をフロントエンドに通知します。

## データモデル

### Firestore コレクション

1. **users**: ユーザー情報
   - ユーザーID、メールアドレス、サブスクリプション情報など

2. **papers**: 論文情報
   - メタデータ、章構成、翻訳ステータス、要約情報など
   - サブコレクション **translated_chapters**: 章ごとの翻訳結果

### Cloud Storage

1. **papers/**: PDFファイルと大きな翻訳テキストを保存
   - PDFファイル: papers/{timestamp}_{ファイル名}.pdf
   - 翻訳テキスト: papers/translated_text_{timestamp}_{paper_id}.txt

## セキュリティ実装

### Firestore セキュリティルール

Firestoreのセキュリティルールを実装し、ユーザーが自分のデータのみにアクセスできるようにしています：
- userコレクションのドキュメントは、認証されたユーザー自身のみが読み書き可能
- papersコレクションのドキュメントは、所有者のみが読み書き可能
- translated_chaptersサブコレクションも同様に、所有者のみがアクセス可能

### Storage セキュリティルール

Cloud Storageのセキュリティルールも同様に、ファイルの所有者のみがアクセスできるように設定しています：
- PDFファイルのアップロードは認証済みユーザーのみ可能
- ファイルの読み取りは、CloudFunctionsの署名付きURLを通じてのみ許可
- 削除操作も所有者のみが実行可能

### その他のセキュリティ対策

- **入力検証**: ファイルタイプ、サイズ、リクエストパラメータなどの検証を実施
- **HTML サニタイズ**: 翻訳結果のHTMLをサニタイズし、XSS攻撃を防止
- **認証**: Firebase Authentication を使用したユーザー認証の実装
- **署名付きURL**: Cloud Storageファイルへのアクセスに署名付きURLを使用（有効期限5分）

## プロンプトエンジニアリング

Gemini APIへのプロンプトは、それぞれの処理目的に合わせて最適化されています：

1. **メタデータと章構成抽出**: 論文の基本情報（タイトル、著者、出版年など）と章構成を正確に抽出するためのプロンプト
2. **翻訳**: 学術論文の専門用語を適切に翻訳し、読みやすさと正確性を両立するためのプロンプト
3. **要約**: 各章の重要なポイントを抽出し、簡潔にまとめるためのプロンプト

これらのプロンプトは JSON ファイルとして外部化され、必要に応じて更新できるようになっています。

## エラーハンドリング

以下の箇所でエラーハンドリングを実装しています：

1. **API エラー**: Vertex AI API のエラーを捕捉し、リトライを実装
2. **タスクエラー**: Cloud Tasks のエラーを捕捉し、Firestore のステータスを更新
3. **入力検証エラー**: ユーザー入力の検証に失敗した場合に適切なメッセージを表示
4. **JSONデコードエラー**: API レスポンスの JSON パースに失敗した場合のフォールバック処理
5. **ログ記録**: すべてのエラーを Cloud Logging に構造化ログとして記録

## フロントエンド実装の更新

既存のフロントエンドコードを更新し、バックエンドと連携するための機能を追加しました：

1. **API連携**: Cloud Functions へのリクエスト送信処理を実装
2. **進捗表示**: Firestore の変更をリアルタイムで監視し、翻訳の進捗状況を表示
3. **署名付きURL取得**: PDF ファイルと翻訳テキストのダウンロード用に署名付きURLを取得
4. **エラー表示**: ユーザーフレンドリーなエラーメッセージと再試行機能

## パフォーマンス最適化

1. **コンテキストキャッシュ**: Vertex AI のコンテキストキャッシュを使用して、PDFの再読み込みを回避
2. **並列処理**: 章ごとの翻訳を Cloud Tasks で並列処理し、全体の処理時間を短縮
3. **大容量テキスト対応**: 大きな翻訳結果は Firestore ではなく Cloud Storage に保存
4. **リソース管理**: 処理完了後にコンテキストキャッシュを削除し、リソースを解放

## 運用監視

1. **構造化ログ**: Cloud Logging 用に構造化されたログ出力を実装
2. **エラー通知**: Cloud Error Reporting との連携（エラーをJSON形式で出力）
3. **メトリクス**: 処理時間、翻訳量などの主要なメトリクスを記録

## 今後の展望

1. **関連論文推薦の強化**: 現在はダミーデータを使用していますが、将来的には Semantic Scholar API などを使用して実装予定
2. **プロンプトの継続的改善**: 翻訳と要約の品質向上のためのプロンプト最適化
3. **メタデータ手動修正機能**: ユーザーがメタデータを修正できる機能の実装
4. **バッチ処理**: 複数のPDFを一括でアップロード・処理する機能
5. **オフライン対応**: PWA対応とオフラインでの閲覧機能

## まとめ

Smart Paper v2 は、Cloud Functions と Vertex AI を連携させることで、高品質な論文翻訳と要約を提供します。非同期処理アーキテクチャにより、大量のPDFファイルを効率的に処理できるシステムを実現しています。また、セキュリティとパフォーマンスに配慮した設計により、ユーザーの論文データを安全かつ効率的に管理しています。